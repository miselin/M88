bits 16
cpu 8086

section .data

global _kbascii
global _kbascii_shift
global _kbascii_ctrl
global _kbascii_alt
global kbnumpad
global kbnumpad_numlock
global vgafont

_kbascii:
    db 0x00     ; 0x00
    db 0x1B     ; ESC
    db '1'
    db '2'
    db '3'
    db '4'
    db '5'
    db '6'
    db '7'
    db '8'
    db '9'
    db '0'
    db '-'
    db '='
    db 0x08     ; Backspace
    db 0x09     ; Tab
    db 'q'      ; 0x10
    db 'w'
    db 'e'
    db 'r'
    db 't'
    db 'y'
    db 'u'
    db 'i'
    db 'o'
    db 'p'
    db '['
    db ']'
    db 0x0D     ; Enter
    db 0x00 ; LCtrl
    db 'a'
    db 's'
    db 'd'      ; 0x20
    db 'f'
    db 'g'
    db 'h'
    db 'j'
    db 'k'
    db 'l'
    db ';'
    db 0x27 ; '
    db '`'
    db 0x00 ; LShift
    db 0x5C     ; Backslash
    db 'z'
    db 'x'
    db 'c'
    db 'v'
    db 'b'      ; 0x30
    db 'n'
    db 'm'
    db ','
    db '.'
    db '/'
    db 0x00  ; RShift
    db '*'
    db 0x00  ; LAlt
    db ' '
    db 0x00  ; CapsLock
    db 0x00  ; F1
    db 0x00  ; F2
    db 0x00  ; F3
    db 0x00  ; F4
    db 0x00  ; F5
    db 0x00  ; 0x40 - F6
    db 0x00  ; F7
    db 0x00  ; F8
    db 0x00  ; F9
    db 0x00  ; F10
    db 0x00  ; NumLock
    db 0x00  ; ScrollLock

_kbascii_shift:
    db 0x00
    db 0x1B  ; ESC
    db '!'
    db '@'
    db '#'
    db '$'
    db '%'
    db '^'
    db '&'
    db '*'
    db '('
    db ')'
    db '_'
    db '+'
    db 0x08     ; Backspace
    db 0x00
    db 'Q'
    db 'W'
    db 'E'
    db 'R'
    db 'T'
    db 'Y'
    db 'U'
    db 'I'
    db 'O'
    db 'P'
    db '{'
    db '}'
    db 0x0D     ; Enter
    db 0x00  ; LCtrl
    db 'A'
    db 'S'
    db 'D'
    db 'F'
    db 'G'
    db 'H'
    db 'J'
    db 'K'
    db 'L'
    db ':'
    db '"'
    db '~'
    db 0x00  ; LShift
    db '|'
    db 'Z'
    db 'X'
    db 'C'
    db 'V'
    db 'B'
    db 'N'
    db 'M'
    db '<'
    db '>'
    db '?'
    db 0x00  ; RShift
    db 0xFF
    db 0x00  ; LAlt
    db ' '
    db 0x00  ; CapsLock
    db 0x00  ; F1
    db 0x00  ; F2
    db 0x00  ; F3
    db 0x00  ; F4
    db 0x00  ; F5
    db 0x00  ; F6
    db 0x00  ; F7
    db 0x00  ; F8
    db 0x00  ; F9
    db 0x00  ; F10
    db 0x00  ; NumLock
    db 0x00  ; ScrollLock

_kbascii_ctrl:
    db 0x00
    db 0x1B  ; ESC
    db 0xFF
    db 0x00
    db 0xFF
    db 0xFF
    db 0xFF
    db 0x1E
    db 0xFF
    db 0xFF
    db 0xFF
    db 0xFF
    db 0x1F
    db 0xFF
    db 0x7F
    db 0x00
    db 'q' - 0x60
    db 'w' - 0x60
    db 'e' - 0x60
    db 'r' - 0x60
    db 't' - 0x60
    db 'y' - 0x60
    db 'u' - 0x60
    db 'i' - 0x60
    db 'o' - 0x60
    db 'p' - 0x60
    db 0x1B
    db 0x1D
    db 0x0A     ; Enter
    db 0x00  ; LCtrl
    db 'a' - 0x60
    db 's' - 0x60
    db 'd' - 0x60
    db 'f' - 0x60
    db 'g' - 0x60
    db 'h' - 0x60
    db 'j' - 0x60
    db 'k' - 0x60
    db 'l' - 0x60
    db 0xFF
    db 0xFF
    db 0xFF
    db 0x00  ; LShift
    db 0x1C
    db 'z' - 0x60
    db 'x' - 0x60
    db 'c' - 0x60
    db 'v' - 0x60
    db 'b' - 0x60
    db 'n' - 0x60
    db 'm' - 0x60
    db 0xFF
    db 0xFF
    db 0xFF
    db 0x00  ; RShift
    db 0x00
    db 0x00  ; LAlt
    db ' '
    db 0x00  ; CapsLock
    db 0x00  ; F1
    db 0x00  ; F2
    db 0x00  ; F3
    db 0x00  ; F4
    db 0x00  ; F5
    db 0x00  ; F6
    db 0x00  ; F7
    db 0x00  ; F8
    db 0x00  ; F9
    db 0x00  ; F10
    db 0x00  ; NumLock
    db 0x00  ; ScrollLock

_kbascii_alt:
    db 0x00
    db 0x1B  ; ESC
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00  ; LCtrl
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0xFF
    db 0xFF
    db 0x00  ; LShift
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0x00
    db 0xFF
    db 0xFF
    db 0xFF
    db 0x00  ; RShift
    db 0x00
    db 0x00  ; LAlt
    db ' '
    db 0x00  ; CapsLock
    db 0x00  ; F1
    db 0x00  ; F2
    db 0x00  ; F3
    db 0x00  ; F4
    db 0x00  ; F5
    db 0x00  ; F6
    db 0x00  ; F7
    db 0x00  ; F8
    db 0x00  ; F9
    db 0x00  ; F10
    db 0x00  ; NumLock
    db 0x00  ; ScrollLock

kbnumpad:
    db 0x00     ; NP 7
    db 0x00     ; NP 8
    db 0x00     ; NP 9
    db '-'      ; NP -
    db 0x00     ; NP 4
    db 0xFF     ; NP 5
    db 0x00     ; NP 6
    db '+'      ; NP +
    db 0x00     ; NP 1
    db 0x00     ; NP 2
    db 0x00     ; NP 3
    db 0x00     ; NP 0
    db 0x00     ; NP .

kbnumpad_numlock:
    db '7'      ; NP 7
    db '8'      ; NP 8
    db '9'      ; NP 9
    db '-'      ; NP -
    db '4'      ; NP 4
    db '5'      ; NP 5
    db '6'      ; NP 6
    db '+'      ; NP +
    db '1'      ; NP 1
    db '2'      ; NP 2
    db '3'      ; NP 3
    db '0'      ; NP 0
    db '.'      ; NP .

section .font

; Character Font for 320x200 & 640x200 Graphics (lower 128 characters)
; This font comes from the fntcol16.zip package (c) by  Joseph Gil
; found at ftp://ftp.simtel.net/pub/simtelnet/msdos/screen/fntcol16.zip
; This font is public domain
vgafont:
    db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x81, 0xa5, 0x81,
    db 0xbd, 0x99, 0x81, 0x7e, 0x7e, 0xff, 0xdb, 0xff, 0xc3, 0xe7, 0xff, 0x7e,
    db 0x6c, 0xfe, 0xfe, 0xfe, 0x7c, 0x38, 0x10, 0x00, 0x10, 0x38, 0x7c, 0xfe,
    db 0x7c, 0x38, 0x10, 0x00, 0x38, 0x7c, 0x38, 0xfe, 0xfe, 0x7c, 0x38, 0x7c,
    db 0x10, 0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x7c, 0x00, 0x00, 0x18, 0x3c,
    db 0x3c, 0x18, 0x00, 0x00, 0xff, 0xff, 0xe7, 0xc3, 0xc3, 0xe7, 0xff, 0xff,
    db 0x00, 0x3c, 0x66, 0x42, 0x42, 0x66, 0x3c, 0x00, 0xff, 0xc3, 0x99, 0xbd,
    db 0xbd, 0x99, 0xc3, 0xff, 0x0f, 0x07, 0x0f, 0x7d, 0xcc, 0xcc, 0xcc, 0x78,
    db 0x3c, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x7e, 0x18, 0x3f, 0x33, 0x3f, 0x30,
    db 0x30, 0x70, 0xf0, 0xe0, 0x7f, 0x63, 0x7f, 0x63, 0x63, 0x67, 0xe6, 0xc0,
    db 0x99, 0x5a, 0x3c, 0xe7, 0xe7, 0x3c, 0x5a, 0x99, 0x80, 0xe0, 0xf8, 0xfe,
    db 0xf8, 0xe0, 0x80, 0x00, 0x02, 0x0e, 0x3e, 0xfe, 0x3e, 0x0e, 0x02, 0x00,
    db 0x18, 0x3c, 0x7e, 0x18, 0x18, 0x7e, 0x3c, 0x18, 0x66, 0x66, 0x66, 0x66,
    db 0x66, 0x00, 0x66, 0x00, 0x7f, 0xdb, 0xdb, 0x7b, 0x1b, 0x1b, 0x1b, 0x00,
    db 0x3e, 0x63, 0x38, 0x6c, 0x6c, 0x38, 0xcc, 0x78, 0x00, 0x00, 0x00, 0x00,
    db 0x7e, 0x7e, 0x7e, 0x00, 0x18, 0x3c, 0x7e, 0x18, 0x7e, 0x3c, 0x18, 0xff,
    db 0x18, 0x3c, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18,
    db 0x7e, 0x3c, 0x18, 0x00, 0x00, 0x18, 0x0c, 0xfe, 0x0c, 0x18, 0x00, 0x00,
    db 0x00, 0x30, 0x60, 0xfe, 0x60, 0x30, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0,
    db 0xc0, 0xfe, 0x00, 0x00, 0x00, 0x24, 0x66, 0xff, 0x66, 0x24, 0x00, 0x00,
    db 0x00, 0x18, 0x3c, 0x7e, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0x7e,
    db 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    db 0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00, 0x6c, 0x6c, 0x6c, 0x00,
    db 0x00, 0x00, 0x00, 0x00, 0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00,
    db 0x30, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x30, 0x00, 0x00, 0xc6, 0xcc, 0x18,
    db 0x30, 0x66, 0xc6, 0x00, 0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00,
    db 0x60, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x30, 0x60, 0x60,
    db 0x60, 0x30, 0x18, 0x00, 0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00,
    db 0x00, 0x66, 0x3c, 0xff, 0x3c, 0x66, 0x00, 0x00, 0x00, 0x30, 0x30, 0xfc,
    db 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60,
    db 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    db 0x00, 0x30, 0x30, 0x00, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00,
    db 0x7c, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0x7c, 0x00, 0x30, 0x70, 0x30, 0x30,
    db 0x30, 0x30, 0xfc, 0x00, 0x78, 0xcc, 0x0c, 0x38, 0x60, 0xcc, 0xfc, 0x00,
    db 0x78, 0xcc, 0x0c, 0x38, 0x0c, 0xcc, 0x78, 0x00, 0x1c, 0x3c, 0x6c, 0xcc,
    db 0xfe, 0x0c, 0x1e, 0x00, 0xfc, 0xc0, 0xf8, 0x0c, 0x0c, 0xcc, 0x78, 0x00,
    db 0x38, 0x60, 0xc0, 0xf8, 0xcc, 0xcc, 0x78, 0x00, 0xfc, 0xcc, 0x0c, 0x18,
    db 0x30, 0x30, 0x30, 0x00, 0x78, 0xcc, 0xcc, 0x78, 0xcc, 0xcc, 0x78, 0x00,
    db 0x78, 0xcc, 0xcc, 0x7c, 0x0c, 0x18, 0x70, 0x00, 0x00, 0x30, 0x30, 0x00,
    db 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60,
    db 0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x00, 0x00, 0x00, 0xfc, 0x00,
    db 0x00, 0xfc, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60, 0x00,
    db 0x78, 0xcc, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00, 0x7c, 0xc6, 0xde, 0xde,
    db 0xde, 0xc0, 0x78, 0x00, 0x30, 0x78, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00,
    db 0xfc, 0x66, 0x66, 0x7c, 0x66, 0x66, 0xfc, 0x00, 0x3c, 0x66, 0xc0, 0xc0,
    db 0xc0, 0x66, 0x3c, 0x00, 0xf8, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0xf8, 0x00,
    db 0xfe, 0x62, 0x68, 0x78, 0x68, 0x62, 0xfe, 0x00, 0xfe, 0x62, 0x68, 0x78,
    db 0x68, 0x60, 0xf0, 0x00, 0x3c, 0x66, 0xc0, 0xc0, 0xce, 0x66, 0x3e, 0x00,
    db 0xcc, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0xcc, 0x00, 0x78, 0x30, 0x30, 0x30,
    db 0x30, 0x30, 0x78, 0x00, 0x1e, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78, 0x00,
    db 0xe6, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0xe6, 0x00, 0xf0, 0x60, 0x60, 0x60,
    db 0x62, 0x66, 0xfe, 0x00, 0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6, 0xc6, 0x00,
    db 0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00, 0x38, 0x6c, 0xc6, 0xc6,
    db 0xc6, 0x6c, 0x38, 0x00, 0xfc, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00,
    db 0x78, 0xcc, 0xcc, 0xcc, 0xdc, 0x78, 0x1c, 0x00, 0xfc, 0x66, 0x66, 0x7c,
    db 0x6c, 0x66, 0xe6, 0x00, 0x78, 0xcc, 0xe0, 0x70, 0x1c, 0xcc, 0x78, 0x00,
    db 0xfc, 0xb4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00, 0xcc, 0xcc, 0xcc, 0xcc,
    db 0xcc, 0xcc, 0xfc, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00,
    db 0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00, 0xc6, 0xc6, 0x6c, 0x38,
    db 0x38, 0x6c, 0xc6, 0x00, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x30, 0x78, 0x00,
    db 0xfe, 0xc6, 0x8c, 0x18, 0x32, 0x66, 0xfe, 0x00, 0x78, 0x60, 0x60, 0x60,
    db 0x60, 0x60, 0x78, 0x00, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x02, 0x00,
    db 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78, 0x00, 0x10, 0x38, 0x6c, 0xc6,
    db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
    db 0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0c,
    db 0x7c, 0xcc, 0x76, 0x00, 0xe0, 0x60, 0x60, 0x7c, 0x66, 0x66, 0xdc, 0x00,
    db 0x00, 0x00, 0x78, 0xcc, 0xc0, 0xcc, 0x78, 0x00, 0x1c, 0x0c, 0x0c, 0x7c,
    db 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x78, 0xcc, 0xfc, 0xc0, 0x78, 0x00,
    db 0x38, 0x6c, 0x60, 0xf0, 0x60, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x76, 0xcc,
    db 0xcc, 0x7c, 0x0c, 0xf8, 0xe0, 0x60, 0x6c, 0x76, 0x66, 0x66, 0xe6, 0x00,
    db 0x30, 0x00, 0x70, 0x30, 0x30, 0x30, 0x78, 0x00, 0x0c, 0x00, 0x0c, 0x0c,
    db 0x0c, 0xcc, 0xcc, 0x78, 0xe0, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0xe6, 0x00,
    db 0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0xcc, 0xfe,
    db 0xfe, 0xd6, 0xc6, 0x00, 0x00, 0x00, 0xf8, 0xcc, 0xcc, 0xcc, 0xcc, 0x00,
    db 0x00, 0x00, 0x78, 0xcc, 0xcc, 0xcc, 0x78, 0x00, 0x00, 0x00, 0xdc, 0x66,
    db 0x66, 0x7c, 0x60, 0xf0, 0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0x1e,
    db 0x00, 0x00, 0xdc, 0x76, 0x66, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x7c, 0xc0,
    db 0x78, 0x0c, 0xf8, 0x00, 0x10, 0x30, 0x7c, 0x30, 0x30, 0x34, 0x18, 0x00,
    db 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0xcc, 0xcc,
    db 0xcc, 0x78, 0x30, 0x00, 0x00, 0x00, 0xc6, 0xd6, 0xfe, 0xfe, 0x6c, 0x00,
    db 0x00, 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0xcc, 0xcc,
    db 0xcc, 0x7c, 0x0c, 0xf8, 0x00, 0x00, 0xfc, 0x98, 0x30, 0x64, 0xfc, 0x00,
    db 0x1c, 0x30, 0x30, 0xe0, 0x30, 0x30, 0x1c, 0x00, 0x18, 0x18, 0x18, 0x00,
    db 0x18, 0x18, 0x18, 0x00, 0xe0, 0x30, 0x30, 0x1c, 0x30, 0x30, 0xe0, 0x00,
    db 0x76, 0xdc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x6c,
    db 0xc6, 0xc6, 0xfe, 0x00,
